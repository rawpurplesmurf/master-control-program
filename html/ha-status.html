<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="vie            <a class="navbar-brand" href="/html/admin.html">
                <i class="bi bi-house-gear-fill"></i> MCP Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/html/admin.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/html/ha-status.html">
                            <i class="bi bi-house-check-fill"></i> HA Status
                        </a>
                    </li>
                </ul>
            </div>
    <title>Home Assistant Status - MCP Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { 
            padding: 1rem; 
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .entity-card {
            margin-bottom: 1rem;
            border-left: 4px solid #0d6efd;
        }
        .entity-card.light { border-left-color: #ffc107; }
        .entity-card.switch { border-left-color: #198754; }
        .entity-card.sensor { border-left-color: #dc3545; }
        .entity-card.climate { border-left-color: #20c997; }
        .entity-card.media_player { border-left-color: #6f42c1; }
        .entity-card.binary_sensor { border-left-color: #fd7e14; }
        .entity-card.cover { border-left-color: #6c757d; }
        .entity-card.lock { border-left-color: #0dcaf0; }
        
        .entity-state {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .state-on { background-color: #d4edda; color: #155724; }
        .state-off { background-color: #f8d7da; color: #721c24; }
        .state-unknown { background-color: #e2e3e5; color: #383d41; }
        .state-unavailable { background-color: #fff3cd; color: #856404; }
        
        .attribute-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin: 0.125rem;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .domain-filter {
            margin: 0.25rem;
        }
        
        .search-container {
            position: sticky;
            top: 76px;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            z-index: 100;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .last-updated {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .control-buttons {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            position: relative;
        }
        
        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.executing {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .control-btn.executing::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .btn-turn-on {
            background-color: #28a745;
            color: white;
        }
        
        .btn-turn-off {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-toggle {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-climate {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-cover {
            background-color: #6f42c1;
            color: white;
        }
        
            .action-feedback {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.875rem;
                z-index: 10;
            }
            
            .spin {
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .control-btn.success {
                background-color: #198754 !important;
                border-color: #198754 !important;
                color: white !important;
            }
            
            .control-btn.error {
                background-color: #dc3545 !important;
                border-color: #dc3545 !important;
                color: white !important;
            }
            
            .control-btn:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }        .entity-controllable {
            position: relative;
        }
        
        .entity-controllable::before {
            content: '\F4A1';
            font-family: "Bootstrap Icons";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.75rem;
            color: #28a745;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="admin.html">
                <i class="bi bi-house-gear-fill"></i> MCP Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="ha-status.html">
                            <i class="bi bi-house-check-fill"></i> HA Status
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/html/prompt-history.html">
                            <i class="bi bi-clock-history"></i> Prompt History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/html/skippy-chat.html">
                            <i class="bi bi-robot"></i> Skippy Chat
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="navbar-text last-updated" id="lastUpdated">
                            <i class="bi bi-clock"></i> Never refreshed
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="bi bi-hdd-rack-fill fs-1 mb-2"></i>
                        <h5 class="card-title">Total Entities</h5>
                        <h2 class="mb-0" id="totalEntities">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle-fill fs-1 mb-2"></i>
                        <h5 class="card-title">Available</h5>
                        <h2 class="mb-0" id="availableEntities">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-exclamation-triangle-fill fs-1 mb-2"></i>
                        <h5 class="card-title">Unavailable</h5>
                        <h2 class="mb-0" id="unavailableEntities">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-collection-fill fs-1 mb-2"></i>
                        <h5 class="card-title">Domains</h5>
                        <h2 class="mb-0" id="totalDomains">-</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-container">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search entities...">
                    </div>
                </div>
                <div class="col-md-6" id="domainFilters">
                    <!-- Domain filter buttons will be populated here -->
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadHAStatus()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Entities Container -->
        <div id="entitiesContainer" class="row" style="display: none;">
            <!-- Entity cards will be populated here -->
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="alert alert-danger" style="display: none;" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Error:</strong> <span id="errorText"></span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allEntities = [];
        let currentFilter = '';

        // Load HA Status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadHAStatus();
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            filterEntities();
        });

        function loadHAStatus() {
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('entitiesContainer').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // First check if HA is available via health check
            fetch('/api/health/ha')
                .then(response => response.json())
                .then(healthData => {
                    if (healthData.status === 'error') {
                        throw new Error('Home Assistant is not available: ' + healthData.detail);
                    }
                    
                    // If HA is healthy, get entities from cache
                    return fetch('/api/ha/entities');
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(entities => {
                    allEntities = entities;
                    displayEntities(entities);
                    updateStatistics(entities);
                    createDomainFilters(entities);
                    updateLastRefreshed();
                })
                .catch(error => {
                    console.error('Error loading HA status:', error);
                    showError(error.message);
                })
                .finally(() => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }

        function displayEntities(entities) {
            const container = document.getElementById('entitiesContainer');
            container.innerHTML = '';

            if (entities.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle-fill"></i>
                            No entities found matching current filters.
                        </div>
                    </div>
                `;
                container.style.display = 'block';
                return;
            }

            // Group entities by domain
            const groupedEntities = {};
            entities.forEach(entity => {
                const domain = entity.entity_id.split('.')[0];
                if (!groupedEntities[domain]) {
                    groupedEntities[domain] = [];
                }
                groupedEntities[domain].push(entity);
            });

            // Sort domains alphabetically
            const sortedDomains = Object.keys(groupedEntities).sort();

            sortedDomains.forEach(domain => {
                // Create domain section
                const domainSection = document.createElement('div');
                domainSection.className = 'col-12 mb-3';
                domainSection.innerHTML = `
                    <h4 class="text-primary border-bottom pb-2">
                        <i class="bi bi-${getDomainIcon(domain)}"></i> 
                        ${domain.charAt(0).toUpperCase() + domain.slice(1)} 
                        <span class="badge bg-secondary">${groupedEntities[domain].length}</span>
                    </h4>
                `;
                container.appendChild(domainSection);

                // Create entities row for this domain
                const entitiesRow = document.createElement('div');
                entitiesRow.className = 'row';
                
                groupedEntities[domain].forEach(entity => {
                    const entityCard = createEntityCard(entity);
                    entitiesRow.appendChild(entityCard);
                });

                container.appendChild(entitiesRow);
            });

            container.style.display = 'block';
        }

        function createEntityCard(entity) {
            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 col-sm-12 mb-3';

            const domain = entity.entity_id.split('.')[0];
            const stateClass = getStateClass(entity.state);
            
            // Format attributes
            let attributesHtml = '';
            if (entity.attributes) {
                const importantAttrs = ['friendly_name', 'unit_of_measurement', 'device_class', 'state_class', 'brightness', 'temperature', 'humidity'];
                importantAttrs.forEach(attr => {
                    if (entity.attributes[attr] !== undefined) {
                        attributesHtml += `<span class="attribute-badge">${attr}: ${entity.attributes[attr]}</span>`;
                    }
                });
            }

            // Check if entity is controllable and add control buttons
            const controlButtons = getControlButtons(entity, domain);
            const controllableClass = controlButtons ? 'entity-controllable' : '';
            
            col.innerHTML = `
                <div class="card entity-card ${domain} ${controllableClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-${getDomainIcon(domain)}"></i>
                                ${entity.attributes?.friendly_name || entity.entity_id}
                            </h6>
                            <span class="entity-state ${stateClass}">${entity.state}</span>
                        </div>
                        <p class="card-text small text-muted mb-2">${entity.entity_id}</p>
                        ${attributesHtml ? `<div class="mb-2">${attributesHtml}</div>` : ''}
                        ${controlButtons || ''}
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> 
                            ${entity.last_changed ? new Date(entity.last_changed).toLocaleString() : 'Unknown'}
                        </small>
                    </div>
                </div>
            `;
            return col;
        }

        function getDomainIcon(domain) {
            const icons = {
                'light': 'lightbulb',
                'switch': 'toggle-on',
                'sensor': 'thermometer-half',
                'binary_sensor': 'record-circle',
                'climate': 'thermometer-sun',
                'media_player': 'music-note-beamed',
                'cover': 'window-sidebar',
                'lock': 'lock',
                'camera': 'camera-video',
                'device_tracker': 'geo-alt',
                'person': 'person',
                'automation': 'gear',
                'script': 'play-circle',
                'input_boolean': 'toggle2-on',
                'input_select': 'list-ul',
                'input_number': 'hash',
                'input_text': 'fonts',
                'timer': 'stopwatch',
                'counter': 'plus-circle',
                'weather': 'cloud-sun',
                'sun': 'sun'
            };
            return icons[domain] || 'gear';
        }

        function getStateClass(state) {
            if (!state) return 'state-unknown';
            const lowerState = state.toLowerCase();
            if (['on', 'open', 'unlocked', 'home', 'active', 'detected'].includes(lowerState)) {
                return 'state-on';
            } else if (['off', 'closed', 'locked', 'away', 'inactive', 'clear'].includes(lowerState)) {
                return 'state-off';
            } else if (['unavailable'].includes(lowerState)) {
                return 'state-unavailable';
            } else {
                return 'state-unknown';
            }
        }

        function getControlButtons(entity, domain) {
            const entityId = entity.entity_id;
            const state = entity.state;
            
            // Define controllable domains and their buttons
            switch (domain) {
                case 'light':
                    if (state === 'on') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-off" onclick="controlDevice('${entityId}', 'turn_off')">
                                    <i class="bi bi-lightbulb"></i> Turn Off
                                </button>
                            </div>
                        `;
                    } else if (state === 'off') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-on" onclick="controlDevice('${entityId}', 'turn_on')">
                                    <i class="bi bi-lightbulb-fill"></i> Turn On
                                </button>
                            </div>
                        `;
                    }
                    break;
                
                case 'switch':
                case 'input_boolean':
                    if (state === 'on') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-off" onclick="controlDevice('${entityId}', 'turn_off')">
                                    <i class="bi bi-toggle-off"></i> Turn Off
                                </button>
                            </div>
                        `;
                    } else if (state === 'off') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-on" onclick="controlDevice('${entityId}', 'turn_on')">
                                    <i class="bi bi-toggle-on"></i> Turn On
                                </button>
                            </div>
                        `;
                    }
                    break;
                
                case 'cover':
                    return `
                        <div class="control-buttons">
                            <button class="control-btn btn-cover" onclick="controlDevice('${entityId}', 'open_cover')">
                                <i class="bi bi-arrow-up"></i> Open
                            </button>
                            <button class="control-btn btn-cover" onclick="controlDevice('${entityId}', 'close_cover')">
                                <i class="bi bi-arrow-down"></i> Close
                            </button>
                        </div>
                    `;
                
                case 'climate':
                    return `
                        <div class="control-buttons">
                            <button class="control-btn btn-climate" onclick="controlDevice('${entityId}', 'turn_on')">
                                <i class="bi bi-power"></i> Turn On
                            </button>
                            <button class="control-btn btn-climate" onclick="controlDevice('${entityId}', 'turn_off')">
                                <i class="bi bi-power"></i> Turn Off
                            </button>
                        </div>
                    `;
                
                case 'fan':
                    if (state === 'on') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-off" onclick="controlDevice('${entityId}', 'turn_off')">
                                    <i class="bi bi-fan"></i> Turn Off
                                </button>
                            </div>
                        `;
                    } else if (state === 'off') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-on" onclick="controlDevice('${entityId}', 'turn_on')">
                                    <i class="bi bi-fan"></i> Turn On
                                </button>
                            </div>
                        `;
                    }
                    break;
                
                case 'script':
                case 'scene':
                    return `
                        <div class="control-buttons">
                            <button class="control-btn btn-toggle" onclick="controlDevice('${entityId}', 'trigger')">
                                <i class="bi bi-play-fill"></i> Run
                            </button>
                        </div>
                    `;
                
                case 'automation':
                    return `
                        <div class="control-buttons">
                            <button class="control-btn btn-toggle" onclick="controlDevice('${entityId}', 'trigger')">
                                <i class="bi bi-play-fill"></i> Trigger
                            </button>
                        </div>
                    `;
                
                case 'lock':
                    if (state === 'locked') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-off" onclick="controlDevice('${entityId}', 'unlock')">
                                    <i class="bi bi-unlock"></i> Unlock
                                </button>
                            </div>
                        `;
                    } else if (state === 'unlocked') {
                        return `
                            <div class="control-buttons">
                                <button class="control-btn btn-turn-on" onclick="controlDevice('${entityId}', 'lock')">
                                    <i class="bi bi-lock-fill"></i> Lock
                                </button>
                            </div>
                        `;
                    }
                    break;
            }
            
            return null; // No control buttons for this entity
        }

        async function controlDevice(entityId, action) {
            const button = event.target.closest('.control-btn');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.classList.add('loading');
            button.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Working...';
            button.disabled = true;
            
            try {
                // Build proper service name from entity domain and action
                const domain = entityId.split('.')[0];
                let service;
                
                // Map actions to proper service calls
                switch (action) {
                    case 'turn_on':
                    case 'turn_off':
                    case 'toggle':
                        service = `${domain}.${action}`;
                        break;
                    case 'open_cover':
                    case 'close_cover':
                    case 'stop_cover':
                        service = `cover.${action.replace('_cover', '_cover')}`;
                        break;
                    case 'lock':
                    case 'unlock':
                        service = `lock.${action}`;
                        break;
                    case 'trigger':
                        // For scripts, scenes, automations
                        if (domain === 'script' || domain === 'scene') {
                            service = `${domain}.${entityId.split('.')[1]}`;
                        } else if (domain === 'automation') {
                            service = `automation.trigger`;
                        } else {
                            service = `homeassistant.turn_on`;
                        }
                        break;
                    default:
                        service = `${domain}.${action}`;
                }
                
                console.log(`🎯 Sending action: ${service} to ${entityId}`);
                
                const actionPayload = {
                    service: service,
                    entity_id: entityId
                };
                
                const response = await fetch('/api/ha/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(actionPayload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Action failed');
                }
                
                const result = await response.json();
                console.log('✅ Action result:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Action execution failed');
                }
                
                // Show success feedback
                button.classList.remove('loading');
                button.classList.add('success');
                button.innerHTML = '<i class="bi bi-check-circle"></i> Done!';
                
                console.log('✅ Action succeeded:', result);
                showAlert(`✅ ${service} executed successfully on ${entityId}`, 'success');
                
                // Reset button immediately and update UI optimistically
                setTimeout(() => {
                    button.classList.remove('success');
                    button.disabled = false;
                    
                    // Update button state optimistically based on action
                    updateButtonAfterAction(button, entityId, action);
                    
                }, 800); // Much shorter delay
                
                // Refresh entity data in background after server has time to update cache (6 seconds)
                setTimeout(() => {
                    refreshSingleEntity(entityId);
                }, 6000);
                
            } catch (error) {
                console.error('❌ Control device error:', error);
                
                // Show error feedback
                button.classList.remove('loading');
                button.classList.add('error');
                button.innerHTML = '<i class="bi bi-exclamation-circle"></i> Error';
                
                // Show error message
                showAlert(`Failed to control ${entityId}: ${error.message}`, 'danger');
                
                // Reset button after delay
                setTimeout(() => {
                    button.classList.remove('error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 3000);
            }
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function updateStatistics(entities) {
            const total = entities.length;
            const available = entities.filter(e => e.state !== 'unavailable').length;
            const unavailable = total - available;
            const domains = [...new Set(entities.map(e => e.entity_id.split('.')[0]))];

            document.getElementById('totalEntities').textContent = total;
            document.getElementById('availableEntities').textContent = available;
            document.getElementById('unavailableEntities').textContent = unavailable;
            document.getElementById('totalDomains').textContent = domains.length;
        }

        function createDomainFilters(entities) {
            const domains = [...new Set(entities.map(e => e.entity_id.split('.')[0]))];
            domains.sort();

            const container = document.getElementById('domainFilters');
            container.innerHTML = '';

            // Add "All" button
            const allBtn = document.createElement('button');
            allBtn.className = 'btn btn-outline-secondary btn-sm domain-filter active';
            allBtn.textContent = 'All';
            allBtn.onclick = () => setDomainFilter('');
            container.appendChild(allBtn);

            // Add domain buttons
            domains.forEach(domain => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary btn-sm domain-filter';
                btn.innerHTML = `<i class="bi bi-${getDomainIcon(domain)}"></i> ${domain}`;
                btn.onclick = () => setDomainFilter(domain);
                container.appendChild(btn);
            });
        }

        function setDomainFilter(domain) {
            currentFilter = domain;
            
            // Update button states
            document.querySelectorAll('.domain-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            filterEntities();
        }

        function filterEntities() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filteredEntities = allEntities;

            // Filter by domain
            if (currentFilter) {
                filteredEntities = filteredEntities.filter(entity => 
                    entity.entity_id.startsWith(currentFilter + '.')
                );
            }

            // Filter by search term
            if (searchTerm) {
                filteredEntities = filteredEntities.filter(entity =>
                    entity.entity_id.toLowerCase().includes(searchTerm) ||
                    (entity.attributes?.friendly_name && 
                     entity.attributes.friendly_name.toLowerCase().includes(searchTerm)) ||
                    entity.state.toLowerCase().includes(searchTerm)
                );
            }

            displayEntities(filteredEntities);
        }

        function updateLastRefreshed() {
            const now = new Date();
            document.getElementById('lastUpdated').innerHTML = 
                `<i class="bi bi-clock"></i> Last updated: ${now.toLocaleTimeString()}`;
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('entitiesContainer').style.display = 'none';
        }

        // NEW: Function to update button state optimistically based on expected outcome
        function updateButtonAfterAction(button, entityId, action) {
            const domain = entityId.split('.')[0];
            
            // Predict new state and update button accordingly
            switch (action) {
                case 'turn_on':
                    if (domain === 'light') {
                        button.innerHTML = '<i class="bi bi-lightbulb"></i> Turn Off';
                        button.className = 'control-btn btn-turn-off';
                        button.onclick = () => controlDevice(entityId, 'turn_off');
                    } else {
                        button.innerHTML = '<i class="bi bi-toggle-off"></i> Turn Off';
                        button.className = 'control-btn btn-turn-off';
                        button.onclick = () => controlDevice(entityId, 'turn_off');
                    }
                    break;
                    
                case 'turn_off':
                    if (domain === 'light') {
                        button.innerHTML = '<i class="bi bi-lightbulb-fill"></i> Turn On';
                        button.className = 'control-btn btn-turn-on';
                        button.onclick = () => controlDevice(entityId, 'turn_on');
                    } else {
                        button.innerHTML = '<i class="bi bi-toggle-on"></i> Turn On';
                        button.className = 'control-btn btn-turn-on';
                        button.onclick = () => controlDevice(entityId, 'turn_on');
                    }
                    break;
                    
                case 'lock':
                    button.innerHTML = '<i class="bi bi-unlock"></i> Unlock';
                    button.className = 'control-btn btn-turn-off';
                    button.onclick = () => controlDevice(entityId, 'unlock');
                    break;
                    
                case 'unlock':
                    button.innerHTML = '<i class="bi bi-lock-fill"></i> Lock';
                    button.className = 'control-btn btn-turn-on';
                    button.onclick = () => controlDevice(entityId, 'lock');
                    break;
            }
        }

        // NEW: Function to refresh single entity state without full page reload
        async function refreshSingleEntity(entityId) {
            try {
                console.log(`🔄 Refreshing state for ${entityId}`);
                
                // Get fresh entity data
                const response = await fetch(`/api/ha/entities`);
                if (!response.ok) {
                    console.warn('Could not refresh entity data');
                    return;
                }
                
                const entities = await response.json();
                const entity = entities.find(e => e.entity_id === entityId);
                
                if (entity) {
                    console.log(`✅ Updated state for ${entityId}: ${entity.state}`);
                    
                    // Find the entity card and update its state display
                    const entityCards = document.querySelectorAll('.entity-card');
                    entityCards.forEach(card => {
                        const cardTitle = card.querySelector('.card-text');
                        if (cardTitle && cardTitle.textContent === entityId) {
                            // Update state badge
                            const stateBadge = card.querySelector('.entity-state');
                            if (stateBadge) {
                                stateBadge.textContent = entity.state;
                                stateBadge.className = `entity-state ${getStateClass(entity.state)}`;
                            }
                            
                            // Update last changed time
                            const timeElement = card.querySelector('small');
                            if (timeElement && entity.last_changed) {
                                timeElement.innerHTML = `<i class="bi bi-clock"></i> ${new Date(entity.last_changed).toLocaleString()}`;
                            }
                            
                            // Update control buttons to match actual state
                            const controlButtons = card.querySelector('.control-buttons');
                            if (controlButtons) {
                                const domain = entityId.split('.')[0];
                                const newButtons = getControlButtons(entity, domain);
                                if (newButtons) {
                                    controlButtons.innerHTML = newButtons.replace('<div class="control-buttons">', '').replace('</div>', '');
                                }
                            }
                        }
                    });
                } else {
                    console.warn(`Entity ${entityId} not found in refresh data`);
                }
            } catch (error) {
                console.error('Error refreshing single entity:', error);
            }
        }
    </script>
</body>
</html>