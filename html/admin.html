<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Admin Interface</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { padding: 1rem; background-color: #f8f9fa; }
        .section { margin-bottom: 2rem; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .navbar-brand { font-weight: bold; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/html/admin.html">
                <i class="bi bi-house-gear-fill"></i> MCP Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/html/admin.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/html/ha-status.html">
                            <i class="bi bi-house-check-fill"></i> HA Status
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/html/prompt-history.html">
                            <i class="bi bi-clock-history"></i> Prompt History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/html/skippy-chat.html">
                            <i class="bi bi-robot"></i> Skippy Chat
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4">Master Control Program Admin Dashboard</h1>
        <div class="section">
            <h2>Health Checks</h2>
            <div id="healthchecks" class="mb-3"></div>
            <button class="btn btn-primary" onclick="loadHealthChecks()">Refresh Health Status</button>
        </div>
        <div class="section">
            <h2>Prompt Templates</h2>
            <div class="mb-2">
                <button class="btn btn-success" onclick="showPromptTemplateForm()">Add New Template</button>
            </div>
            <div id="prompt-templates-table" class="table-responsive"></div>
            <div id="prompt-template-form" style="display:none;"></div>
        </div>
        <div class="section">
            <h2>Data Fetchers</h2>
            <div class="mb-2">
                <button class="btn btn-success" onclick="showDataFetcherForm()">Add New Fetcher</button>
                <button class="btn btn-info" onclick="loadDataFetchers()">Refresh List</button>
            </div>
            <div id="data-fetchers-table" class="table-responsive"></div>
            <div id="data-fetcher-form" style="display:none;"></div>
        </div>
        <div class="section">
            <h2>Rules</h2>
            <div class="mb-2">
                <button class="btn btn-success" onclick="showSkippyGuardrailForm()">Add Skippy Guardrail</button>
                <button class="btn btn-primary" onclick="showSubmindAutomationForm()">Add Submind Automation</button>
                <button class="btn btn-info" onclick="loadRules()">Refresh List</button>
            </div>
            <div class="mb-2">
                <label>Filter by type: 
                    <select class="form-select d-inline-block" style="width: auto;" onchange="filterRulesByType(this.value)">
                        <option value="">All Rules</option>
                        <option value="skippy_guardrail">Skippy Guardrails</option>
                        <option value="submind_automation">Submind Automations</option>
                    </select>
                </label>
            </div>
            <div id="rules-table" class="table-responsive"></div>
            <div id="rule-form" style="display:none;"></div>
        </div>
        <!-- Add more sections for other endpoints as needed -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
    // Use the current host for API calls
    const API_BASE = window.location.origin;

    // Healthcheck endpoints
    const healthEndpoints = [
        { name: 'Database', url: API_BASE + '/api/health/db' },
        { name: 'Redis', url: API_BASE + '/api/health/redis' },
        { name: 'Home Assistant', url: API_BASE + '/api/health/homeassistant' },
        { name: 'Ollama', url: API_BASE + '/api/health/ollama' }
    ];
    async function loadHealthChecks() {
        const container = document.getElementById('healthchecks');
        container.innerHTML = '';
        for (const hc of healthEndpoints) {
            try {
                const res = await axios.get(hc.url);
                container.innerHTML += `<div><strong>${hc.name}:</strong> <span class="text-success">${JSON.stringify(res.data)}</span></div>`;
            } catch (e) {
                container.innerHTML += `<div><strong>${hc.name}:</strong> <span class="text-danger">Error: ${e?.response?.data?.detail || e.message}</span></div>`;
            }
        }
    }
    // Prompt Templates CRUD
    async function loadPromptTemplates() {
        const tableDiv = document.getElementById('prompt-templates-table');
        tableDiv.innerHTML = 'Loading...';
        try {
            const res = await axios.get(API_BASE + '/api/prompts');
            const rows = res.data.map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.template_name}</td>
                    <td>${t.intent_keywords}</td>
                    <td>${t.system_prompt}</td>
                    <td>${t.user_template}</td>
                    <td>${JSON.stringify(t.pre_fetch_data)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editPromptTemplate(${t.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePromptTemplate(${t.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            tableDiv.innerHTML = `<table class="table table-bordered table-sm"><thead><tr><th>ID</th><th>Name</th><th>Keywords</th><th>System Prompt</th><th>User Template</th><th>Pre-fetch Data</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
        } catch (e) {
            tableDiv.innerHTML = `<div class="text-danger">Failed to load prompt templates: ${e.message}</div>`;
        }
    }
    function showPromptTemplateForm(template) {
        const formDiv = document.getElementById('prompt-template-form');
        formDiv.style.display = 'block';
        formDiv.innerHTML = `
            <form onsubmit="submitPromptTemplateForm(event, ${template ? template.id : 'null'})">
                <div class="mb-2"><label>Name: <input class="form-control" name="template_name" value="${template?.template_name || ''}" required></label></div>
                <div class="mb-2"><label>Intent Keywords: <input class="form-control" name="intent_keywords" value="${template?.intent_keywords || ''}" required></label></div>
                <div class="mb-2"><label>System Prompt: <textarea class="form-control" name="system_prompt" required>${template?.system_prompt || ''}</textarea></label></div>
                <div class="mb-2"><label>User Template: <textarea class="form-control" name="user_template" required>${template?.user_template || ''}</textarea></label></div>
                <div class="mb-2">
                    <label>Pre-fetch Data (JSON Array):</label>
                    <textarea class="form-control" name="pre_fetch_data" rows="3" required>${template ? JSON.stringify(template.pre_fetch_data, null, 2) : '[\n  "ha_device_status",\n  "rules_list",\n  "current_time"\n]'}</textarea>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="validateJSON(this.form.pre_fetch_data)">Validate JSON</button>
                    <small class="form-text text-muted">Valid JSON array format required. Use double quotes for strings. Example: ["item1", "item2", "item3"]</small>
                </div>
                <button class="btn btn-primary" type="submit">${template ? 'Update' : 'Create'}</button>
                <button class="btn btn-secondary" type="button" onclick="hidePromptTemplateForm()">Cancel</button>
            </form>
        `;
    }
    function hidePromptTemplateForm() {
        const formDiv = document.getElementById('prompt-template-form');
        formDiv.style.display = 'none';
        formDiv.innerHTML = '';
    }
    async function submitPromptTemplateForm(event, id) {
        event.preventDefault();
        const form = event.target;
        
        // Validate and parse JSON for pre_fetch_data
        let preFetchData;
        try {
            preFetchData = JSON.parse(form.pre_fetch_data.value);
        } catch (jsonError) {
            alert(`Invalid JSON in Pre-fetch Data field.\n\nError: ${jsonError.message}\n\nCommon fixes:\n• Use double quotes (") not single quotes (')\n• No trailing commas\n• Escape special characters like backslashes\n• Check for unmatched brackets`);
            return;
        }
        
        const data = {
            template_name: form.template_name.value,
            intent_keywords: form.intent_keywords.value,
            system_prompt: form.system_prompt.value,
            user_template: form.user_template.value,
            pre_fetch_data: preFetchData
        };
        
        console.log('Sending data:', data);
        
        try {
            if (id) {
                await axios.put(API_BASE + `/api/prompts/${id}`, data);
            } else {
                await axios.post(API_BASE + '/api/prompts', data);
            }
            hidePromptTemplateForm();
            loadPromptTemplates();
        } catch (e) {
            console.error('Full error object:', e);
            console.error('Response data:', e?.response?.data);
            const errorDetail = e?.response?.data?.detail || e?.response?.data || e.message;
            alert('Error: ' + JSON.stringify(errorDetail));
        }
    }
    
    function validateJSON(textarea) {
        try {
            const parsed = JSON.parse(textarea.value);
            alert('✓ Valid JSON!\n\nParsed object:\n' + JSON.stringify(parsed, null, 2));
        } catch (e) {
            alert('✗ Invalid JSON!\n\nError: ' + e.message + '\n\nPlease fix the syntax before submitting.');
        }
    }
    
    async function editPromptTemplate(id) {
        try {
            const res = await axios.get(API_BASE + `/api/prompts/${id}`);
            showPromptTemplateForm(res.data);
        } catch (e) {
            alert('Failed to load template: ' + e.message);
        }
    }
    async function deletePromptTemplate(id) {
        if (!confirm('Delete this template?')) return;
        try {
            await axios.delete(API_BASE + `/api/prompts/${id}`);
            loadPromptTemplates();
        } catch (e) {
            alert('Failed to delete: ' + e.message);
        }
    }
    // Rules CRUD (simplified, adjust fields as needed)
    async function loadRules() {
        const tableDiv = document.getElementById('rules-table');
        tableDiv.innerHTML = 'Loading...';
        try {
            const res = await axios.get(API_BASE + '/api/rules');
            const rows = res.data.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td>${r.rule_name}</td>
                    <td><span class="badge ${r.rule_type === 'skippy_guardrail' ? 'bg-warning' : 'bg-info'}">${r.rule_type}</span></td>
                    <td>${r.description || 'N/A'}</td>
                    <td><span class="badge ${r.is_active ? 'bg-success' : 'bg-secondary'}">${r.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>${r.priority}</td>
                    <td>
                        ${r.rule_type === 'submind_automation' ? `<button class="btn btn-sm btn-warning" onclick="executeRule(${r.id})">Execute</button>` : ''}
                        <button class="btn btn-sm btn-primary" onclick="editRule(${r.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRule(${r.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            tableDiv.innerHTML = `<table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>`;
        } catch (e) {
            tableDiv.innerHTML = `<div class="text-danger">Failed to load rules: ${e.message}</div>`;
        }
    }

    async function filterRulesByType(ruleType) {
        const tableDiv = document.getElementById('rules-table');
        tableDiv.innerHTML = 'Loading...';
        try {
            const url = ruleType ? API_BASE + `/api/rules?rule_type=${ruleType}` : API_BASE + '/api/rules';
            const res = await axios.get(url);
            const rows = res.data.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td>${r.rule_name}</td>
                    <td><span class="badge ${r.rule_type === 'skippy_guardrail' ? 'bg-warning' : 'bg-info'}">${r.rule_type}</span></td>
                    <td>${r.description || 'N/A'}</td>
                    <td><span class="badge ${r.is_active ? 'bg-success' : 'bg-secondary'}">${r.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>${r.priority}</td>
                    <td>
                        ${r.rule_type === 'submind_automation' ? `<button class="btn btn-sm btn-warning" onclick="executeRule(${r.id})">Execute</button>` : ''}
                        <button class="btn btn-sm btn-primary" onclick="editRule(${r.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRule(${r.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            tableDiv.innerHTML = `<table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>`;
        } catch (e) {
            tableDiv.innerHTML = `<div class="text-danger">Failed to load rules: ${e.message}</div>`;
        }
    }
    function showSkippyGuardrailForm(rule) {
        const formDiv = document.getElementById('rule-form');
        formDiv.style.display = 'block';
        formDiv.innerHTML = `
            <h4>${rule ? 'Edit' : 'Create'} Skippy Guardrail</h4>
            <form onsubmit="submitRuleForm(event, ${rule ? rule.id : 'null'})">
                <input type="hidden" name="rule_type" value="skippy_guardrail">
                <div class="mb-2"><label>Name: <input class="form-control" name="rule_name" value="${rule?.rule_name || ''}" required></label></div>
                <div class="mb-2"><label>Description: <textarea class="form-control" name="description">${rule?.description || ''}</textarea></label></div>
                <div class="mb-2"><label>Priority: <input type="number" class="form-control" name="priority" value="${rule?.priority || 0}"></label></div>
                <div class="mb-2"><label>Active: <input type="checkbox" class="form-check-input" name="is_active" ${rule?.is_active !== false ? 'checked' : ''}></label></div>
                <div class="mb-2"><label>Target Entity Pattern: <input class="form-control" name="target_entity_pattern" value="${rule?.target_entity_pattern || ''}" placeholder="e.g., light.garden_*"></label></div>
                <div class="mb-2"><label>Blocked Actions (JSON): <textarea class="form-control" name="blocked_actions" placeholder='["turn_on", "turn_off"]'>${rule?.blocked_actions ? JSON.stringify(rule.blocked_actions) : '[]'}</textarea></label></div>
                <div class="mb-2"><label>Guard Conditions (JSON): <textarea class="form-control" name="guard_conditions" placeholder='{"time_after": "sunset", "brightness": {"lt": 50}}'>${rule?.guard_conditions ? JSON.stringify(rule.guard_conditions) : '{}'}</textarea></label></div>
                <div class="mb-2"><label>Override Keywords: <input class="form-control" name="override_keywords" value="${rule?.override_keywords || ''}" placeholder="emergency, force, override"></label></div>
                <button class="btn btn-primary" type="submit">${rule ? 'Update' : 'Create'} Guardrail</button>
                <button class="btn btn-secondary" type="button" onclick="hideRuleForm()">Cancel</button>
            </form>
        `;
    }

    function showSubmindAutomationForm(rule) {
        const formDiv = document.getElementById('rule-form');
        formDiv.style.display = 'block';
        formDiv.innerHTML = `
            <h4>${rule ? 'Edit' : 'Create'} Submind Automation</h4>
            <form onsubmit="submitRuleForm(event, ${rule ? rule.id : 'null'})">
                <input type="hidden" name="rule_type" value="submind_automation">
                <div class="mb-2"><label>Name: <input class="form-control" name="rule_name" value="${rule?.rule_name || ''}" required></label></div>
                <div class="mb-2"><label>Description: <textarea class="form-control" name="description">${rule?.description || ''}</textarea></label></div>
                <div class="mb-2"><label>Priority: <input type="number" class="form-control" name="priority" value="${rule?.priority || 0}"></label></div>
                <div class="mb-2"><label>Active: <input type="checkbox" class="form-check-input" name="is_active" ${rule?.is_active !== false ? 'checked' : ''}></label></div>
                <div class="mb-2"><label>Trigger Conditions (JSON): <textarea class="form-control" name="trigger_conditions" placeholder='{"entity": "person.john", "state": "home", "time_after": "sunset"}'>${rule?.trigger_conditions ? JSON.stringify(rule.trigger_conditions) : '{}'}</textarea></label></div>
                <div class="mb-2"><label>Target Actions (JSON): <textarea class="form-control" name="target_actions" placeholder='[{"service": "light.turn_on", "entity_id": "light.living_room", "data": {"brightness": 180}}]'>${rule?.target_actions ? JSON.stringify(rule.target_actions) : '[]'}</textarea></label></div>
                <div class="mb-2"><label>Execution Schedule: <input class="form-control" name="execution_schedule" value="${rule?.execution_schedule || ''}" placeholder="* * * * * (cron format, optional)"></label></div>
                <button class="btn btn-primary" type="submit">${rule ? 'Update' : 'Create'} Automation</button>
                <button class="btn btn-secondary" type="button" onclick="hideRuleForm()">Cancel</button>
            </form>
        `;
    }
    function hideRuleForm() {
        const formDiv = document.getElementById('rule-form');
        formDiv.style.display = 'none';
        formDiv.innerHTML = '';
    }
    async function submitRuleForm(event, id) {
        event.preventDefault();
        const form = event.target;
        const data = {
            rule_name: form.rule_name.value,
            rule_type: form.rule_type.value,
            description: form.description.value,
            is_active: form.is_active.checked,
            priority: parseInt(form.priority.value) || 0
        };

        // Add type-specific fields
        if (data.rule_type === 'skippy_guardrail') {
            data.target_entity_pattern = form.target_entity_pattern.value;
            data.override_keywords = form.override_keywords.value;
            try {
                data.blocked_actions = JSON.parse(form.blocked_actions.value || '[]');
                data.guard_conditions = JSON.parse(form.guard_conditions.value || '{}');
            } catch (e) {
                alert('Invalid JSON in blocked actions or guard conditions');
                return;
            }
        } else if (data.rule_type === 'submind_automation') {
            data.execution_schedule = form.execution_schedule.value;
            try {
                data.trigger_conditions = JSON.parse(form.trigger_conditions.value || '{}');
                data.target_actions = JSON.parse(form.target_actions.value || '[]');
            } catch (e) {
                alert('Invalid JSON in trigger conditions or target actions');
                return;
            }
        }

        try {
            if (id) {
                await axios.put(API_BASE + `/api/rules/${id}`, data);
            } else {
                await axios.post(API_BASE + '/api/rules', data);
            }
            hideRuleForm();
            loadRules();
        } catch (e) {
            alert('Error: ' + (e?.response?.data?.detail || e.message));
        }
    }
    async function editRule(id) {
        try {
            const res = await axios.get(API_BASE + `/api/rules/${id}`);
            const rule = res.data;
            if (rule.rule_type === 'skippy_guardrail') {
                showSkippyGuardrailForm(rule);
            } else {
                showSubmindAutomationForm(rule);
            }
        } catch (e) {
            alert('Failed to load rule: ' + e.message);
        }
    }

    async function executeRule(id) {
        try {
            const res = await axios.post(API_BASE + `/api/rules/${id}/execute`);
            alert(res.data.message);
            loadRules(); // Refresh to show updated execution count
        } catch (e) {
            alert('Failed to execute rule: ' + (e?.response?.data?.detail || e.message));
        }
    }
    async function deleteRule(id) {
        if (!confirm('Delete this rule?')) return;
        try {
            await axios.delete(API_BASE + `/api/rules/${id}`);
            loadRules();
        } catch (e) {
            alert('Failed to delete: ' + e.message);
        }
    }
    
    // Data Fetchers CRUD
    async function loadDataFetchers() {
        const tableDiv = document.getElementById('data-fetchers-table');
        tableDiv.innerHTML = 'Loading...';
        try {
            const res = await axios.get(API_BASE + '/api/data-fetchers');
            const rows = res.data.map(f => `
                <tr>
                    <td>${f.id}</td>
                    <td><code>${f.fetcher_key}</code></td>
                    <td>${f.description}</td>
                    <td>${f.ttl_seconds}s</td>
                    <td>${f.is_active ? '<span class="text-success">Yes</span>' : '<span class="text-danger">No</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editDataFetcher('${f.fetcher_key}')">Edit</button>
                        <button class="btn btn-sm btn-info" onclick="testDataFetcher('${f.fetcher_key}')">Test</button>
                        <button class="btn btn-sm btn-warning" onclick="refreshDataFetcher('${f.fetcher_key}')">Refresh</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDataFetcher('${f.fetcher_key}')">Delete</button>
                    </td>
                </tr>
            `).join('');
            tableDiv.innerHTML = `<table class="table table-bordered table-sm"><thead><tr><th>ID</th><th>Key</th><th>Description</th><th>TTL</th><th>Active</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
        } catch (e) {
            tableDiv.innerHTML = `<div class="text-danger">Failed to load data fetchers: ${e.message}</div>`;
        }
    }
    
    function showDataFetcherForm(fetcher) {
        const formDiv = document.getElementById('data-fetcher-form');
        formDiv.style.display = 'block';
        formDiv.innerHTML = `
            <form onsubmit="submitDataFetcherForm(event, '${fetcher ? fetcher.fetcher_key : ''}')">
                <div class="mb-2"><label>Fetcher Key: <input class="form-control" name="fetcher_key" value="${fetcher?.fetcher_key || ''}" ${fetcher ? 'readonly' : ''} required></label></div>
                <div class="mb-2"><label>Description: <input class="form-control" name="description" value="${fetcher?.description || ''}" required></label></div>
                <div class="mb-2"><label>TTL Seconds: <input class="form-control" type="number" name="ttl_seconds" value="${fetcher?.ttl_seconds || 300}" required></label></div>
                <div class="mb-2"><label>Active: <input type="checkbox" name="is_active" ${fetcher?.is_active !== false ? 'checked' : ''}></label></div>
                <div class="mb-2">
                    <label>Python Code:</label>
                    <textarea class="form-control" name="python_code" rows="8" required>${fetcher?.python_code || 'import datetime\nresult = {\n    "timestamp": datetime.datetime.now().isoformat()\n}'}</textarea>
                    <small class="form-text text-muted">Code should set a 'result' variable with the data to return</small>
                </div>
                <button class="btn btn-primary" type="submit">${fetcher ? 'Update' : 'Create'}</button>
                <button class="btn btn-secondary" type="button" onclick="hideDataFetcherForm()">Cancel</button>
            </form>
        `;
    }
    
    function hideDataFetcherForm() {
        const formDiv = document.getElementById('data-fetcher-form');
        formDiv.style.display = 'none';
        formDiv.innerHTML = '';
    }
    
    async function submitDataFetcherForm(event, fetcher_key) {
        event.preventDefault();
        const form = event.target;
        
        const data = {
            fetcher_key: form.fetcher_key.value,
            description: form.description.value,
            ttl_seconds: parseInt(form.ttl_seconds.value),
            python_code: form.python_code.value,
            is_active: form.is_active.checked
        };
        
        console.log('Sending data fetcher data:', data);
        
        try {
            if (fetcher_key) {
                await axios.put(API_BASE + `/api/data-fetchers/${fetcher_key}`, data);
            } else {
                await axios.post(API_BASE + '/api/data-fetchers', data);
            }
            hideDataFetcherForm();
            loadDataFetchers();
        } catch (e) {
            console.error('Full error object:', e);
            console.error('Response data:', e?.response?.data);
            const errorDetail = e?.response?.data?.detail || e?.response?.data || e.message;
            alert('Error: ' + JSON.stringify(errorDetail));
        }
    }
    
    async function editDataFetcher(fetcher_key) {
        try {
            const res = await axios.get(API_BASE + `/api/data-fetchers/${fetcher_key}`);
            showDataFetcherForm(res.data);
        } catch (e) {
            alert('Failed to load data fetcher: ' + e.message);
        }
    }
    
    async function deleteDataFetcher(fetcher_key) {
        if (!confirm('Delete this data fetcher?')) return;
        try {
            await axios.delete(API_BASE + `/api/data-fetchers/${fetcher_key}`);
            loadDataFetchers();
        } catch (e) {
            alert('Failed to delete: ' + e.message);
        }
    }
    
    async function testDataFetcher(fetcher_key) {
        try {
            const res = await axios.get(API_BASE + `/api/data-fetchers/${fetcher_key}/test`);
            alert('Test Result:\\n\\n' + JSON.stringify(res.data.result, null, 2));
        } catch (e) {
            alert('Test failed: ' + e.message);
        }
    }
    
    async function refreshDataFetcher(fetcher_key) {
        try {
            const res = await axios.post(API_BASE + `/api/data-fetchers/${fetcher_key}/refresh`);
            alert('Refresh Result:\\n\\n' + JSON.stringify(res.data.result, null, 2));
        } catch (e) {
            alert('Refresh failed: ' + e.message);
        }
    }
    
    // Initial load
    window.onload = function() {
        loadHealthChecks();
        loadPromptTemplates();
        loadDataFetchers();
        loadRules();
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
